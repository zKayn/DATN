%% UC7: Đăng nhập - Sequence Diagram
sequenceDiagram
    title UC7: Đăng nhập

    actor User
    participant UI as Login Form
    participant API as Auth API
    participant DB as Database
    participant Auth as JWT Service

    User->>UI: Nhập email & password
    User->>UI: Click "Đăng nhập"
    UI->>API: POST /api/auth/login {email, password}

    API->>DB: Tìm user theo email

    alt User không tồn tại
        DB-->>API: null
        API-->>UI: 404 "Email không tồn tại"
        UI-->>User: Hiển thị lỗi
    else User tồn tại
        DB-->>API: User data (with password)

        alt Tài khoản bị khóa
            API-->>UI: 403 "Tài khoản đã bị khóa"
            UI-->>User: Hiển thị lỗi
        else Tài khoản active
            API->>API: bcrypt.compare(password, user.matKhau)

            alt Sai mật khẩu
                API-->>UI: 401 "Mật khẩu không đúng"
                UI-->>User: Hiển thị lỗi
            else Đúng mật khẩu
                API->>Auth: Tạo JWT token
                Auth-->>API: token
                API-->>UI: 200 {user, token}
                UI->>UI: Lưu token vào localStorage
                UI->>UI: Cập nhật AuthContext

                alt Admin
                    UI-->>User: Redirect to Admin Dashboard
                else Customer
                    UI-->>User: Redirect to Homepage
                end
            end
        end
    end

---

%% UC10: Đặt hàng - Sequence Diagram
sequenceDiagram
    title UC10: Đặt hàng

    actor Customer
    participant UI as Checkout Page
    participant Cart as Cart Service
    participant Order as Order API
    participant Product as Product Service
    participant Voucher as Voucher Service
    participant Payment as Payment Gateway
    participant Notif as Notification Service
    participant DB as Database

    Customer->>UI: Xem giỏ hàng
    UI->>Cart: Lấy sản phẩm trong giỏ
    Cart-->>UI: Danh sách sản phẩm

    Customer->>UI: Click "Đặt hàng"
    UI->>UI: Chọn địa chỉ giao hàng

    opt Áp dụng voucher
        Customer->>UI: Nhập mã voucher
        UI->>Voucher: POST /api/vouchers/validate

        alt Voucher hợp lệ
            Voucher-->>UI: Giá trị giảm
            UI->>UI: Cập nhật tổng tiền
        else Voucher không hợp lệ
            Voucher-->>UI: Error "Voucher hết hạn/đã hết"
        end
    end

    Customer->>UI: Chọn phương thức thanh toán
    UI->>Order: POST /api/orders/create

    Order->>Product: Kiểm tra tồn kho

    alt Không đủ hàng
        Product-->>Order: Error "Hết hàng"
        Order-->>UI: 400 "Sản phẩm không đủ"
        UI-->>Customer: Hiển thị lỗi
    else Đủ hàng
        Product-->>Order: OK

        alt Thanh toán online (VNPay/MoMo)
            Order->>Payment: Tạo link thanh toán
            Payment-->>Order: Payment URL
            Order-->>UI: Payment URL
            UI-->>Customer: Redirect to Payment Gateway
            Customer->>Payment: Thanh toán

            alt Thanh toán thất bại
                Payment-->>UI: Payment failed
                UI->>Order: Hủy đơn hàng
                Order->>DB: Cập nhật trạng thái = "da-huy"
                UI-->>Customer: Thông báo lỗi
            else Thanh toán thành công
                Payment-->>UI: Payment success
                Payment->>Order: Webhook callback
            end
        end

        Order->>DB: Tạo Order record
        DB-->>Order: Order created

        Order->>Product: Trừ tồn kho
        Product->>DB: Update soLuongTonKho

        Order->>Cart: Xóa giỏ hàng
        Cart->>DB: Clear cart items

        Order->>Notif: Tạo thông báo cho Customer
        Notif->>DB: Create Notification

        Order-->>UI: 201 Order created
        UI-->>Customer: Hiển thị "Đặt hàng thành công"
        UI-->>Customer: Redirect to Order Detail
    end

---

%% UC15: Đánh giá sản phẩm - Sequence Diagram
sequenceDiagram
    title UC15: Đánh giá sản phẩm

    actor Customer
    participant UI as Order Detail Page
    participant Review as Review API
    participant Upload as Cloudinary
    participant Product as Product Service
    participant Notif as Notification Service
    participant DB as Database

    Customer->>UI: Vào "Đơn hàng của tôi"
    UI->>DB: GET /api/orders (trangThai = "da-giao")
    DB-->>UI: Danh sách đơn đã giao

    Customer->>UI: Chọn sản phẩm đánh giá
    UI->>Review: Kiểm tra đã đánh giá chưa
    Review->>DB: Find Review (sanPham + nguoiDung + donHang)

    alt Đã đánh giá
        DB-->>Review: Review exists
        Review-->>UI: 409 "Đã đánh giá"
        UI-->>Customer: Hiển thị thông báo
    else Chưa đánh giá
        DB-->>Review: null
        Review-->>UI: OK, chưa đánh giá

        UI-->>Customer: Mở form đánh giá
        Customer->>UI: Chọn số sao (1-5)
        Customer->>UI: Nhập tiêu đề, nội dung

        opt Upload hình ảnh
            Customer->>UI: Chọn hình ảnh
            UI->>Upload: Upload images
            Upload-->>UI: Image URLs[]
        end

        Customer->>UI: Gửi đánh giá
        UI->>Review: POST /api/reviews/create

        Review->>DB: Create Review
        DB-->>Review: Review created

        Review->>Product: Cập nhật rating
        Product->>DB: Update danhGiaTrungBinh, soLuongDanhGia

        Review->>Notif: Tạo thông báo cho Admin
        Notif->>DB: Create Notification (loai = "danh-gia-moi")

        Review-->>UI: 201 Review created
        UI-->>Customer: Hiển thị "Gửi đánh giá thành công"
    end

---

%% UC25: Cập nhật trạng thái đơn hàng (Real-time) - Sequence Diagram
sequenceDiagram
    title UC25: Cập nhật trạng thái đơn hàng + Real-time sync

    actor Admin
    participant AdminUI as Admin Web
    participant OrderAPI as Order API
    participant DB as Database
    participant NotifAPI as Notification API
    participant MobileApp as Mobile App (Customer)
    participant ProfileScreen as ProfileScreen

    Admin->>AdminUI: Vào "Quản lý đơn hàng"
    AdminUI->>OrderAPI: GET /api/orders
    OrderAPI->>DB: Fetch orders
    DB-->>OrderAPI: Orders list
    OrderAPI-->>AdminUI: Orders data
    AdminUI-->>Admin: Hiển thị danh sách

    Admin->>AdminUI: Chọn đơn hàng
    Admin->>AdminUI: Chọn trạng thái mới
    Admin->>AdminUI: Click "Cập nhật"

    AdminUI->>OrderAPI: PUT /api/orders/:id/status

    OrderAPI->>DB: Update Order
    Note over DB: trangThaiDonHang = new status<br/>lichSuTrangThai.push({...})
    DB-->>OrderAPI: Updated

    alt Hủy đơn hàng
        OrderAPI->>DB: Hoàn tồn kho sản phẩm
        OrderAPI->>DB: Hoàn điểm (nếu có)
    end

    OrderAPI->>NotifAPI: Tạo thông báo
    NotifAPI->>DB: Create Notification
    Note over DB: loai = "don-hang-" + trangThai<br/>nguoiNhan = customer

    OrderAPI-->>AdminUI: 200 Updated
    AdminUI-->>Admin: "Cập nhật thành công"

    Note over MobileApp,ProfileScreen: Real-time Polling (mỗi 10 giây)

    loop Every 10 seconds
        ProfileScreen->>OrderAPI: GET /api/orders (polling)
        OrderAPI->>DB: Fetch user orders
        DB-->>OrderAPI: Latest orders
        OrderAPI-->>ProfileScreen: Orders with new status

        ProfileScreen->>ProfileScreen: So sánh với state cũ

        alt Trạng thái thay đổi
            ProfileScreen->>MobileApp: Update UI
            MobileApp-->>Customer: Hiển thị trạng thái mới
        end
    end

    loop Every 10 seconds (Notification polling)
        MobileApp->>NotifAPI: GET /api/notifications/unread
        NotifAPI->>DB: Fetch unread notifications
        DB-->>NotifAPI: Notifications list
        NotifAPI-->>MobileApp: New notifications
        MobileApp->>MobileApp: Update badge count
        MobileApp-->>Customer: Hiển thị badge thông báo
    end

---

%% UC6: Đăng ký tài khoản - Sequence Diagram
sequenceDiagram
    title UC6: Đăng ký tài khoản

    actor Guest
    participant UI as Register Form
    participant API as Auth API
    participant DB as Database
    participant Auth as JWT Service
    participant Email as Email Service

    Guest->>UI: Truy cập /register
    UI-->>Guest: Hiển thị form đăng ký

    Guest->>UI: Nhập email, password, hoTen, soDienThoai
    Guest->>UI: Click "Đăng ký"

    UI->>UI: Validate form

    alt Validation failed
        UI-->>Guest: Hiển thị lỗi validation
    else Validation OK
        UI->>API: POST /api/auth/register

        API->>DB: Kiểm tra email tồn tại

        alt Email đã tồn tại
            DB-->>API: Email exists
            API-->>UI: 409 "Email đã được sử dụng"
            UI-->>Guest: Hiển thị lỗi
        else Email chưa tồn tại
            DB-->>API: Email available

            API->>API: bcrypt.hash(password, 10)

            API->>DB: Create User
            Note over DB: vaiTro = "khach-hang"<br/>trangThai = "hoat-dong"<br/>diemTichLuy = 0
            DB-->>API: User created

            API->>Auth: Tạo JWT token
            Auth-->>API: token

            opt Gửi email welcome
                API->>Email: Send welcome email
            end

            API-->>UI: 201 {user, token}
            UI->>UI: Lưu token vào localStorage
            UI->>UI: Cập nhật AuthContext
            UI-->>Guest: Redirect to Homepage
        end
    end

---

%% UC8-UC9: Thêm vào giỏ hàng & Quản lý giỏ hàng - Sequence Diagram
sequenceDiagram
    title UC8 & UC9: Thêm vào giỏ hàng & Quản lý giỏ hàng

    actor Customer
    participant UI as Product Detail
    participant CartUI as Cart Page
    participant CartAPI as Cart API
    participant ProductAPI as Product API
    participant DB as Database

    Note over Customer,DB: UC8: Thêm vào giỏ hàng

    Customer->>UI: Xem chi tiết sản phẩm
    Customer->>UI: Chọn size, màu sắc
    Customer->>UI: Chọn số lượng
    Customer->>UI: Click "Thêm vào giỏ hàng"

    UI->>ProductAPI: Kiểm tra tồn kho
    ProductAPI->>DB: Get Product.soLuongTonKho

    alt Không đủ hàng
        DB-->>ProductAPI: soLuongTonKho < quantity
        ProductAPI-->>UI: Error "Không đủ hàng"
        UI-->>Customer: Hiển thị thông báo
    else Đủ hàng
        DB-->>ProductAPI: OK
        ProductAPI-->>UI: Product available

        UI->>CartAPI: POST /api/cart/add
        CartAPI->>DB: Add to Cart or Update quantity
        DB-->>CartAPI: Cart updated
        CartAPI-->>UI: 200 Cart item added
        UI->>UI: Update cart badge
        UI-->>Customer: Hiển thị "Đã thêm vào giỏ"
    end

    Note over Customer,DB: UC9: Quản lý giỏ hàng

    Customer->>CartUI: Click icon giỏ hàng
    CartUI->>CartAPI: GET /api/cart
    CartAPI->>DB: Fetch cart items
    DB-->>CartAPI: Cart items
    CartAPI-->>CartUI: Cart data
    CartUI-->>Customer: Hiển thị danh sách sản phẩm

    loop Chỉnh sửa giỏ hàng
        alt Tăng/Giảm số lượng
            Customer->>CartUI: Click +/-
            CartUI->>CartAPI: PUT /api/cart/update
            CartAPI->>ProductAPI: Kiểm tra tồn kho

            alt Đủ hàng
                ProductAPI-->>CartAPI: OK
                CartAPI->>DB: Update quantity
                DB-->>CartAPI: Updated
                CartAPI-->>CartUI: 200 Updated
                CartUI->>CartUI: Tính lại tổng tiền
                CartUI-->>Customer: Update UI
            else Không đủ hàng
                ProductAPI-->>CartAPI: Out of stock
                CartAPI-->>CartUI: Error
                CartUI-->>Customer: Hiển thị lỗi
            end
        else Xóa sản phẩm
            Customer->>CartUI: Click "Xóa"
            CartUI->>CartAPI: DELETE /api/cart/:itemId
            CartAPI->>DB: Remove item
            DB-->>CartAPI: Deleted
            CartAPI-->>CartUI: 200 Deleted
            CartUI->>CartUI: Tính lại tổng tiền
            CartUI-->>Customer: Update UI
        end
    end

    Customer->>CartUI: Click "Tiến hành đặt hàng"
    CartUI-->>Customer: Redirect to Checkout (UC10)
