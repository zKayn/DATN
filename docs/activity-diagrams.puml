@startuml UC6 - Đăng ký tài khoản

title UC6: Đăng ký tài khoản

start

:Guest truy cập trang đăng ký;

:Nhập thông tin:
- Email
- Mật khẩu
- Họ tên
- Số điện thoại;

if (Email đã tồn tại?) then (yes)
  :Hiển thị lỗi "Email đã được sử dụng";
  stop
else (no)
  if (Mật khẩu >= 6 ký tự?) then (no)
    :Hiển thị lỗi "Mật khẩu quá ngắn";
    stop
  else (yes)
    if (Số điện thoại hợp lệ?) then (no)
      :Hiển thị lỗi "SĐT không hợp lệ";
      stop
    else (yes)
      :Mã hóa mật khẩu (bcrypt);
      :Tạo tài khoản mới trong DB;
      :Gán vaiTro = "khach-hang";
      :Gán trangThai = "hoat-dong";
      :Gán diemTichLuy = 0;
      :Tạo JWT token;
      :Trả về thông tin user;
      :Chuyển hướng đến trang chủ;
      stop
    endif
  endif
endif

@enduml

@startuml UC7 - Đăng nhập

title UC7: Đăng nhập

start

:User nhập email và mật khẩu;

:Gửi request đến API /auth/login;

if (Email tồn tại trong DB?) then (no)
  :Trả về lỗi "Email không tồn tại";
  stop
else (yes)
  :Lấy user từ DB (include password);

  if (Tài khoản bị khóa?) then (yes)
    :Trả về lỗi "Tài khoản đã bị khóa";
    stop
  else (no)
    :So sánh mật khẩu (bcrypt.compare);

    if (Mật khẩu đúng?) then (no)
      :Trả về lỗi "Mật khẩu không đúng";
      stop
    else (yes)
      :Tạo JWT token với:
      - userId
      - vaiTro
      - email;

      if (vaiTro == "quan-tri"?) then (yes)
        :Chuyển đến Admin Dashboard;
      else (no)
        :Chuyển đến Customer Homepage;
      endif

      :Lưu token vào localStorage/AsyncStorage;
      :Cập nhật AuthContext;
      stop
    endif
  endif
endif

@enduml

@startuml UC10 - Đặt hàng

title UC10: Đặt hàng (Place Order)

start

:Customer xem giỏ hàng;

if (Giỏ hàng trống?) then (yes)
  :Hiển thị "Giỏ hàng trống";
  stop
else (no)

  partition "UC17: Quản lý địa chỉ giao hàng" {
    if (Có địa chỉ mặc định?) then (yes)
      :Sử dụng địa chỉ mặc định;
    else (no)
      :Chọn địa chỉ từ danh sách;

      if (Không có địa chỉ nào?) then (yes)
        :Thêm địa chỉ mới:
        - Họ tên người nhận
        - SĐT
        - Tỉnh/Huyện/Xã
        - Địa chỉ chi tiết;
        :Lưu địa chỉ vào DB;
      endif
    endif
  }

  :Chọn phương thức vận chuyển;
  :Tính phí vận chuyển;

  partition "Áp dụng voucher (optional)" {
    if (Có mã giảm giá?) then (yes)
      :Nhập mã voucher;
      :Kiểm tra voucher hợp lệ;

      if (Voucher hợp lệ?) then (yes)
        :Áp dụng giảm giá;
        :Tăng daSuDung voucher;
      else (no)
        :Hiển thị lỗi voucher;
      endif
    endif
  }

  partition "Sử dụng điểm tích lũy (optional)" {
    if (Sử dụng điểm?) then (yes)
      :Chọn số điểm muốn dùng;
      :Tính giảm giá từ điểm;
      :Trừ điểm tạm thời;
    endif
  }

  :Tính tổng thanh toán:
  tongTien + phiVanChuyen - giamGia - giamGiaTuDiem;

  partition "UC11: Thanh toán" {
    :Chọn phương thức thanh toán:
    - COD
    - VNPay
    - MoMo
    - Thẻ ATM;

    if (Phương thức online?) then (yes)
      :Chuyển đến cổng thanh toán;
      :Xử lý thanh toán;

      if (Thanh toán thành công?) then (no)
        :Hủy đơn hàng;
        :Hoàn điểm (nếu có);
        stop
      endif
    endif
  }

  :Tạo đơn hàng trong DB:
  - maDonHang (auto-generated)
  - nguoiDung
  - sanPham (snapshot)
  - diaChiGiaoHang
  - trangThaiDonHang = "cho-xac-nhan";

  :Trừ số lượng tồn kho sản phẩm;
  :Xóa giỏ hàng;

  if (Sử dụng điểm?) then (yes)
    :Tạo PointTransaction:
    - loai = "tru"
    - soLuong
    - donHang ref;
  endif

  if (Thanh toán thành công?) then (yes)
    :Cộng điểm tích lũy (1% tongTien);
    :Tạo PointTransaction:
    - loai = "cong"
    - soLuong
    - donHang ref;
  endif

  :Tạo Notification cho Customer:
  "Đơn hàng #maDonHang đã được tạo";

  :Gửi email xác nhận đơn hàng;

  :Chuyển đến trang "Đặt hàng thành công";
  :Hiển thị thông tin đơn hàng;

  stop
endif

@enduml

@startuml UC15 - Đánh giá sản phẩm

title UC15: Đánh giá sản phẩm

start

:Customer vào trang "Đơn hàng của tôi";

:Chọn đơn hàng đã giao (da-giao);

if (Đơn hàng có trạng thái "da-giao"?) then (no)
  :Hiển thị "Chỉ đánh giá đơn đã giao";
  stop
else (yes)

  :Chọn sản phẩm muốn đánh giá;

  :Kiểm tra đã đánh giá chưa:
  Review.find({sanPham, nguoiDung, donHang});

  if (Đã đánh giá sản phẩm này?) then (yes)
    :Hiển thị "Bạn đã đánh giá sản phẩm này";
    stop
  else (no)

    :Mở form đánh giá;

    :Chọn số sao (1-5);
    :Nhập tiêu đề đánh giá;
    :Nhập nội dung đánh giá;

    if (Upload hình ảnh?) then (yes)
      :Chọn hình ảnh từ thiết bị;
      :Upload lên Cloudinary;
      :Lưu URL hình ảnh;
    endif

    :Gửi đánh giá;

    :Tạo Review trong DB:
    - sanPham ref
    - nguoiDung ref
    - donHang ref
    - danhGia (1-5)
    - tieuDe
    - noiDung
    - hinhAnh[]
    - trangThai = "cho-duyet";

    :Cập nhật Product:
    - soLuongDanhGia += 1
    - danhGiaTrungBinh = average;

    :Tạo Notification cho Admin:
    "Có đánh giá mới cần duyệt";

    :Hiển thị "Gửi đánh giá thành công";
    :Chuyển về trang đơn hàng;

    stop
  endif
endif

@enduml

@startuml UC25 - Cập nhật trạng thái đơn hàng (Real-time)

title UC25: Cập nhật trạng thái đơn hàng (Admin) + Real-time sync to Mobile

|Admin|
start

:Admin vào trang "Quản lý đơn hàng";
:Chọn đơn hàng cần cập nhật;
:Xem chi tiết đơn hàng;

:Chọn trạng thái mới:
- cho-xac-nhan → da-xac-nhan
- da-xac-nhan → dang-chuan-bi
- dang-chuan-bi → dang-giao
- dang-giao → da-giao
- → da-huy
- → tra-hang;

if (Trạng thái hợp lệ?) then (no)
  :Hiển thị lỗi "Không thể chuyển trạng thái";
  stop
else (yes)

  if (Hủy đơn?) then (yes)
    :Nhập lý do hủy;
    :Hoàn số lượng tồn kho;

    if (Đã thanh toán online?) then (yes)
      :Tạo yêu cầu hoàn tiền;
      :Cập nhật trangThaiThanhToan = "hoan-tien";
    endif

    if (Đã sử dụng điểm?) then (yes)
      :Hoàn điểm cho customer;
      :Tạo PointTransaction (loai = "cong");
    endif
  endif

  |Backend|
  :Cập nhật Order trong DB:
  - trangThaiDonHang = new status
  - thêm vào lichSuTrangThai[];

  if (Trạng thái = "da-giao"?) then (yes)
    :Cập nhật giaoThanhCongLuc = now;
    :Tăng Product.daBan;
  endif

  :Tạo Notification cho Customer:
  loai = "don-hang-" + trangThai
  tieuDe = "Đơn hàng #maDonHang"
  noiDung = "Trạng thái: " + trangThai;

  |Mobile App|
  fork
    :ProfileScreen polling (10s):
    Gọi api.getOrders() mỗi 10 giây;

    :Nhận danh sách đơn hàng mới;

    if (Trạng thái thay đổi?) then (yes)
      :Cập nhật UI tự động;
      :Hiển thị trạng thái mới;
    endif
  fork again
    :NotificationContext polling (10s):
    Gọi api.getNotifications();

    :Nhận thông báo mới;
    :Cập nhật unreadCount;
    :Hiển thị badge thông báo;
  end fork

  |Admin|
  :Hiển thị "Cập nhật thành công";
  :Làm mới danh sách đơn hàng;

  stop
endif

@enduml

@startuml UC8-UC9-UC10 - Luồng mua hàng đầy đủ

title Luồng mua hàng đầy đủ: UC8 → UC9 → UC10

|Customer|
start

partition "UC8: Thêm vào giỏ hàng" {
  :Xem chi tiết sản phẩm;
  :Chọn size/màu sắc;
  :Chọn số lượng;

  if (Đã đăng nhập?) then (no)
    :Lưu giỏ hàng vào localStorage;
  else (yes)
    |Backend|
    :Kiểm tra tồn kho;

    if (Đủ hàng?) then (no)
      :Trả về "Không đủ hàng";
      stop
    else (yes)
      :Thêm vào giỏ hàng (Cart Collection);
      |Customer|
      :Hiển thị "Đã thêm vào giỏ";
      :Cập nhật badge giỏ hàng;
    endif
  endif
}

:Tiếp tục mua sắm hoặc xem giỏ;

partition "UC9: Quản lý giỏ hàng" {
  :Customer mở giỏ hàng;
  :Hiển thị danh sách sản phẩm;

  while (Muốn chỉnh sửa?) is (yes)
    :Tăng/Giảm số lượng hoặc Xóa sản phẩm;
    :Cập nhật giỏ hàng;
    :Tính lại tổng tiền;
  endwhile (no)

  :Xem tổng tiền tạm tính;
}

partition "UC10: Đặt hàng" {
  :Nhấn "Tiến hành đặt hàng";

  note right
    Chi tiết ở
    activity diagram
    UC10 riêng
  end note

  :Xem UC10 diagram;
}

stop

@enduml

@startuml UC22 - Quản lý sản phẩm (Admin CRUD)

title UC22: Quản lý sản phẩm (Admin)

|Admin|
start

:Vào trang "Quản lý sản phẩm";
:Hiển thị danh sách sản phẩm với:
- Tìm kiếm
- Lọc theo danh mục
- Phân trang;

:Chọn hành động;

if (Thêm sản phẩm mới?) then (yes)

  partition "Thêm sản phẩm" {
    :Mở form thêm sản phẩm;
    :Nhập thông tin:
    - Tên sản phẩm
    - Mô tả
    - Giá
    - Giá khuyến mãi
    - Danh mục
    - Thương hiệu
    - Kích thước
    - Màu sắc;

    :Upload hình ảnh;
    |Backend|
    :Upload lên Cloudinary;
    :Lấy URL hình ảnh;

    |Admin|
    :Nhập số lượng tồn kho;
    :Chọn trạng thái (active/inactive);
    :Đánh dấu sản phẩm nổi bật (checkbox);
    :Đánh dấu Flash Sale (checkbox);

    :Gửi form;

    |Backend|
    :Tạo slug từ tên sản phẩm;
    :Tạo Product trong DB;

    |Admin|
    :Hiển thị "Thêm thành công";
    :Làm mới danh sách;
  }

elseif (Sửa sản phẩm?) then (yes)

  partition "Sửa sản phẩm" {
    :Chọn sản phẩm cần sửa;
    :Hiển thị form với dữ liệu hiện tại;
    :Cập nhật thông tin;

    if (Thay đổi hình ảnh?) then (yes)
      :Upload hình mới;
      :Xóa hình cũ từ Cloudinary;
    endif

    :Lưu thay đổi;

    |Backend|
    :Cập nhật Product trong DB;

    if (Thay đổi tên?) then (yes)
      :Tạo lại slug;
    endif

    |Admin|
    :Hiển thị "Cập nhật thành công";
  }

elseif (Xóa sản phẩm?) then (yes)

  partition "Xóa sản phẩm" {
    :Chọn sản phẩm cần xóa;
    :Hiển thị confirm dialog;

    if (Xác nhận xóa?) then (yes)

      |Backend|
      :Kiểm tra sản phẩm trong đơn hàng;

      if (Có trong đơn hàng nào?) then (yes)
        :Chuyển trangThai = "inactive";
        :Giữ lại trong DB (soft delete);
      else (no)
        :Xóa hình ảnh từ Cloudinary;
        :Xóa Product khỏi DB (hard delete);
      endif

      |Admin|
      :Hiển thị "Xóa thành công";
      :Làm mới danh sách;
    endif
  }

elseif (Cập nhật tồn kho?) then (yes)

  partition "Cập nhật tồn kho" {
    :Chọn sản phẩm;
    :Nhập số lượng mới;

    |Backend|
    :Cập nhật soLuongTonKho;

    |Admin|
    :Hiển thị "Cập nhật thành công";
  }

endif

stop

@enduml
